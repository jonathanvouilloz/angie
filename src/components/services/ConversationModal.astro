---
// Modal conversationnel immersif
// Header style iMessage avec "Jonathan V." et statut en ligne
// Hauteur fixe pour une lecture confortable

import { scenarios } from '../../data/scenarios';
---

<!-- Modal container -->
<div
  id="conversation-modal"
  class="modal-overlay hidden"
  role="dialog"
  aria-modal="true"
  aria-labelledby="modal-title"
>
  <!-- Backdrop (click to close) -->
  <div class="modal-backdrop" data-close-modal></div>

  <!-- Modal content -->
  <div class="modal-window">
    <!-- Corner boxes decoratifs -->
    <div class="corner-box corner-tl"></div>
    <div class="corner-box corner-tr"></div>
    <div class="corner-box corner-bl"></div>
    <div class="corner-box corner-br"></div>

    <!-- Header style iMessage -->
    <header class="modal-header">
      <!-- Traffic lights -->
      <div class="traffic-lights">
        <button class="traffic-btn red" data-close-modal aria-label="Fermer"></button>
        <span class="traffic-btn yellow"></span>
        <span class="traffic-btn green"></span>
      </div>

      <!-- Contact name -->
      <div class="contact-name">
        <span class="name" id="modal-title">Jonathan V.</span>
      </div>

      <!-- Online status -->
      <div class="online-status">
        <span class="status-dot"></span>
        <span class="status-text">en ligne</span>
      </div>
    </header>

    <!-- Messages container - hauteur fixe -->
    <div class="modal-messages" id="modal-messages">
      <!-- Messages injectés dynamiquement -->

      <!-- Typing indicator -->
      <div class="typing-indicator" id="typing-indicator">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      </div>
    </div>

    <!-- Badge nouveaux messages -->
    <button class="new-messages-badge hidden" id="new-messages-badge">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
        <path d="M12 5v14M19 12l-7 7-7-7"/>
      </svg>
      Nouveaux messages
    </button>

    <!-- Footer CTAs - état réduit par défaut -->
    <footer class="modal-footer" id="modal-footer">
      <a href="/contact" class="btn-primary">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 11.5a8.38 8.38 0 01-.9 3.8 8.5 8.5 0 01-7.6 4.7 8.38 8.38 0 01-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 01-.9-3.8 8.5 8.5 0 014.7-7.6 8.38 8.38 0 013.8-.9h.5a8.48 8.48 0 018 8v.5z"/>
        </svg>
        Me contacter
      </a>
      <button class="btn-secondary" data-scroll-to id="btn-learn-more">
        En savoir plus
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 5v14M19 12l-7 7-7-7"/>
        </svg>
      </button>
    </footer>
  </div>
</div>

<!-- Données des scénarios pour JavaScript -->
<script define:vars={{ scenariosData: scenarios }}>
  window.__scenarios = scenariosData;
</script>

<style>
  /* Overlay */
  .modal-overlay {
    position: fixed;
    inset: 0;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
  }

  .modal-overlay.hidden {
    display: none;
  }

  /* Backdrop */
  .modal-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.88);
    backdrop-filter: blur(4px);
    animation: fadeIn 0.25s ease-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  /* Modal window */
  .modal-window {
    position: relative;
    width: 100%;
    max-width: 480px;
    height: 580px;
    background: white;
    border: 3px solid black;
    box-shadow: 8px 8px 0px rgba(0, 0, 0, 0.4);
    display: flex;
    flex-direction: column;
    animation: modalIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    overflow: hidden;
  }

  @keyframes modalIn {
    from {
      opacity: 0;
      transform: scale(0.95) translateY(10px);
    }
    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }

  /* Corner boxes */
  .corner-box {
    position: absolute;
    width: 10px;
    height: 10px;
    background: var(--blue, #00D9A3);
    border: 2px solid black;
    z-index: 10;
  }

  .corner-tl { top: -5px; left: -5px; }
  .corner-tr { top: -5px; right: -5px; }
  .corner-bl { bottom: -5px; left: -5px; }
  .corner-br { bottom: -5px; right: -5px; }

  /* Header style iMessage */
  .modal-header {
    display: flex;
    align-items: center;
    padding: 0.875rem 1rem;
    border-bottom: 2px solid black;
    background: #f8f8f8;
    gap: 1rem;
  }

  .traffic-lights {
    display: flex;
    gap: 6px;
  }

  .traffic-btn {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 1px solid rgba(0, 0, 0, 0.15);
  }

  .traffic-btn.red {
    background: #ff5f57;
    cursor: pointer;
    transition: opacity 0.2s;
  }

  .traffic-btn.red:hover {
    opacity: 0.8;
  }

  .traffic-btn.yellow { background: #febc2e; }
  .traffic-btn.green { background: #28c840; }

  .contact-name {
    flex: 1;
    text-align: center;
  }

  .contact-name .name {
    font-weight: 600;
    font-size: 0.9rem;
  }

  .online-status {
    display: flex;
    align-items: center;
    gap: 5px;
  }

  .status-dot {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    background: #28c840;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  .status-text {
    font-size: 0.7rem;
    color: #888;
  }

  /* Messages container - hauteur fixe */
  .modal-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1.25rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    background: white;
  }

  /* Scrollbar */
  .modal-messages::-webkit-scrollbar {
    width: 6px;
  }

  .modal-messages::-webkit-scrollbar-track {
    background: transparent;
  }

  .modal-messages::-webkit-scrollbar-thumb {
    background: #ddd;
    border-radius: 3px;
  }

  /* Typing indicator */
  .typing-indicator {
    display: none;
    align-items: center;
    gap: 4px;
    padding: 0.625rem 0.875rem;
    background: #f0f0f0;
    border-radius: 18px 18px 18px 4px;
    width: fit-content;
    align-self: flex-start;
  }

  .typing-indicator.visible {
    display: flex;
  }

  .typing-dot {
    width: 6px;
    height: 6px;
    background: #999;
    border-radius: 50%;
    animation: typingBounce 1.2s infinite ease-in-out;
  }

  .typing-dot:nth-child(2) { animation-delay: 0.15s; }
  .typing-dot:nth-child(3) { animation-delay: 0.3s; }

  @keyframes typingBounce {
    0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
    30% { transform: translateY(-4px); opacity: 1; }
  }

  /* Badge nouveaux messages */
  .new-messages-badge {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    align-items: center;
    gap: 0.4rem;
    background: var(--blue, #00D9A3);
    border: 2px solid black;
    padding: 0.5rem 0.875rem;
    font-size: 0.75rem;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 2px 2px 0 black;
    z-index: 10;
    animation: badgeBounce 0.3s ease;
    transition: all 0.15s ease;
  }

  .new-messages-badge:hover {
    box-shadow: 1px 1px 0 black;
    transform: translateX(-50%) translate(1px, 1px);
  }

  .new-messages-badge.hidden {
    display: none;
  }

  @keyframes badgeBounce {
    0% { opacity: 0; transform: translateX(-50%) translateY(10px); }
    100% { opacity: 1; transform: translateX(-50%) translateY(0); }
  }

  /* Footer - état réduit par défaut */
  .modal-footer {
    display: flex;
    gap: 0.75rem;
    padding: 0;
    height: 6px;
    border-top: 2px solid black;
    background: #f8f8f8;
    overflow: hidden;
    transition: all 0.4s ease;
  }

  .modal-footer.expanded {
    height: auto;
    padding: 1rem;
  }

  /* Buttons */
  .btn-primary,
  .btn-secondary {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.4rem;
    padding: 0.75rem 1rem;
    font-size: 0.85rem;
    font-weight: 500;
    border: 2px solid black;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
  }

  .btn-primary {
    background: var(--blue, #00D9A3);
    color: black;
    box-shadow: 3px 3px 0px rgba(0, 0, 0, 0.8);
  }

  .btn-primary:hover {
    box-shadow: 1px 1px 0px rgba(0, 0, 0, 0.8);
    transform: translate(2px, 2px);
  }

  .btn-secondary {
    background: white;
    color: var(--text, #0F172A);
  }

  .btn-secondary:hover {
    background: #f5f5f5;
  }

  /* Responsive */
  @media (max-width: 540px) {
    .modal-window {
      height: 85vh;
      max-height: 600px;
    }

    .modal-header {
      padding: 0.75rem;
    }

    .status-text {
      display: none;
    }

    .modal-footer {
      flex-direction: column;
      gap: 0.5rem;
    }
  }
</style>

<style is:global>
  /* Styles des messages créés dynamiquement */
  .chat-message {
    display: flex;
    max-width: 85%;
    opacity: 0;
    transform: translateY(10px);
    animation: msgIn 0.35s ease-out forwards;
  }

  @keyframes msgIn {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .chat-message.client {
    align-self: flex-start;
  }

  .chat-message.jon {
    align-self: flex-end;
  }

  .chat-bubble {
    padding: 0.625rem 0.875rem;
    font-size: 0.875rem;
    line-height: 1.45;
    color: var(--text, #0F172A);
  }

  .chat-message.client .chat-bubble {
    background: #f0f0f0;
    border-radius: 18px 18px 18px 4px;
  }

  /* Vert plus clair pour Jon - meilleure lisibilité */
  .chat-message.jon .chat-bubble {
    background: #7EECD3;
    border-radius: 18px 18px 4px 18px;
  }

  /* Animation de sortie du modal */
  @keyframes fadeOut {
    to { opacity: 0; }
  }

  /* Highlight de section après scroll */
  .highlight-section {
    animation: sectionPulse 1.5s ease-out;
  }

  @keyframes sectionPulse {
    0%, 100% { box-shadow: none; }
    50% { box-shadow: inset 0 0 0 3px var(--blue, #00D9A3); }
  }
</style>

<script>
  interface Message {
    speaker: 'client' | 'jon';
    text: string;
  }

  interface Scenario {
    id: string;
    emoji: string;
    title: string;
    pillar: string;
    scrollTo: string;
    messages: Message[];
  }

  const scenarios: Scenario[] = (window as any).__scenarios || [];

  const modal = document.getElementById('conversation-modal');
  const messagesContainer = document.getElementById('modal-messages');
  const typingIndicator = document.getElementById('typing-indicator');
  const footer = document.getElementById('modal-footer');
  const btnLearnMore = document.getElementById('btn-learn-more');
  const newMessagesBadge = document.getElementById('new-messages-badge');

  let currentScenario: Scenario | null = null;
  let animationTimeouts: number[] = [];

  // Détecte si l'utilisateur est proche du bas du conteneur
  function isNearBottom(container: HTMLElement, threshold = 100): boolean {
    const { scrollTop, scrollHeight, clientHeight } = container;
    return scrollHeight - scrollTop - clientHeight < threshold;
  }

  // Affiche/cache le badge nouveaux messages
  function updateNewMessagesBadge(show: boolean) {
    if (!newMessagesBadge) return;
    if (show) {
      newMessagesBadge.classList.remove('hidden');
    } else {
      newMessagesBadge.classList.add('hidden');
    }
  }

  // Scroll vers le bas et cache le badge
  function scrollToBottom() {
    if (messagesContainer) {
      messagesContainer.scrollTo({
        top: messagesContainer.scrollHeight,
        behavior: 'smooth'
      });
    }
    updateNewMessagesBadge(false);
  }

  // Écouter le scroll pour cacher le badge quand on arrive en bas
  messagesContainer?.addEventListener('scroll', () => {
    if (messagesContainer && isNearBottom(messagesContainer)) {
      updateNewMessagesBadge(false);
    }
  });

  // Clic sur le badge → scroll vers le bas
  newMessagesBadge?.addEventListener('click', scrollToBottom);

  function openModal(scenarioId: string) {
    const scenario = scenarios.find(s => s.id === scenarioId);
    if (!scenario || !modal) return;

    currentScenario = scenario;

    // Vider les messages précédents
    if (messagesContainer) {
      const existingMessages = messagesContainer.querySelectorAll('.chat-message');
      existingMessages.forEach(msg => msg.remove());
    }

    // Reset footer (état réduit)
    if (footer) footer.classList.remove('expanded');

    // Cacher le badge
    updateNewMessagesBadge(false);

    // Afficher le modal
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';

    // Animer les messages
    animateMessages(scenario.messages);

    // Mettre à jour le bouton "En savoir plus"
    if (btnLearnMore) {
      btnLearnMore.setAttribute('data-scroll-to', scenario.scrollTo);
    }
  }

  function animateMessages(messages: Message[]) {
    animationTimeouts.forEach(t => clearTimeout(t));
    animationTimeouts = [];

    if (typingIndicator) typingIndicator.classList.add('visible');

    let delay = 500;

    messages.forEach((msg, index) => {
      const timeout = window.setTimeout(() => {
        const messageEl = createMessageElement(msg);

        if (messagesContainer && typingIndicator) {
          messagesContainer.insertBefore(messageEl, typingIndicator);
          // Scroll intelligent : ne scroller que si l'utilisateur est près du bas
          if (isNearBottom(messagesContainer)) {
            messagesContainer.scrollTo({
              top: messagesContainer.scrollHeight,
              behavior: 'smooth'
            });
          } else {
            // Afficher le badge si l'utilisateur n'est pas en bas
            updateNewMessagesBadge(true);
          }
        }

        if (index === messages.length - 1) {
          const hideTyping = window.setTimeout(() => {
            if (typingIndicator) typingIndicator.classList.remove('visible');
            const showFooter = window.setTimeout(() => {
              if (footer) {
                footer.classList.add('expanded');
                // Cacher le badge et scroll vers le bas pour voir les CTAs
                updateNewMessagesBadge(false);
                setTimeout(() => {
                  if (messagesContainer) {
                    messagesContainer.scrollTo({
                      top: messagesContainer.scrollHeight,
                      behavior: 'smooth'
                    });
                  }
                }, 50);
              }
            }, 400);
            animationTimeouts.push(showFooter);
          }, 300);
          animationTimeouts.push(hideTyping);
        }
      }, delay);

      animationTimeouts.push(timeout);

      // Délai variable selon longueur du texte (ralenti pour lecture confortable)
      const readTime = Math.min(msg.text.length * 18, 900);
      delay += 1000 + readTime + Math.random() * 300;
    });
  }

  function createMessageElement(msg: Message): HTMLElement {
    const wrapper = document.createElement('div');
    wrapper.className = `chat-message ${msg.speaker}`;

    const bubble = document.createElement('div');
    bubble.className = 'chat-bubble';
    bubble.textContent = msg.text;

    wrapper.appendChild(bubble);
    return wrapper;
  }

  function closeModal() {
    if (!modal) return;

    modal.style.animation = 'fadeOut 0.2s ease-out forwards';

    setTimeout(() => {
      modal.classList.add('hidden');
      modal.style.animation = '';
      document.body.style.overflow = '';

      animationTimeouts.forEach(t => clearTimeout(t));
      animationTimeouts = [];
    }, 200);
  }

  // Event listeners
  document.querySelectorAll('[data-close-modal]').forEach(el => {
    el.addEventListener('click', closeModal);
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modal && !modal.classList.contains('hidden')) {
      closeModal();
    }
  });

  document.querySelectorAll('[data-scenario-id]').forEach(bubble => {
    bubble.addEventListener('click', () => {
      const scenarioId = bubble.getAttribute('data-scenario-id');
      if (scenarioId) openModal(scenarioId);
    });
  });

  if (btnLearnMore) {
    btnLearnMore.addEventListener('click', () => {
      const scrollTo = btnLearnMore.getAttribute('data-scroll-to');
      closeModal();

      if (scrollTo) {
        setTimeout(() => {
          const section = document.getElementById(scrollTo);
          if (section) {
            section.scrollIntoView({ behavior: 'smooth', block: 'start' });
            section.classList.add('highlight-section');
            setTimeout(() => section.classList.remove('highlight-section'), 1500);
          }
        }, 250);
      }
    });
  }

  (window as any).openScenarioModal = openModal;
</script>
