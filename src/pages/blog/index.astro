---
import '../../styles/global.css';
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import AppHeader from '../../components/Header.astro';
import AppFooter from '../../components/Footer.astro';
import BlogHero from '../../components/blog/BlogHero.astro';
import BlogFilters from '../../components/blog/BlogFilters.astro';
import FeaturedGrid from '../../components/blog/FeaturedGrid.astro';
import PostListItem from '../../components/blog/PostListItem.astro';

// Get all published posts
const allPosts = await getCollection('blog', ({ data }) => !data.draft);

// Sort by date (newest first)
const sortedPosts = allPosts.sort((a, b) =>
  b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

// Get featured post (first one marked as featured, or most recent)
const featuredPost = sortedPosts.find((post) => post.data.featured) || sortedPosts[0];

// Get next 2 posts for the grid (excluding featured)
const postsExcludingFeatured = sortedPosts.filter((post) => post.slug !== featuredPost?.slug);
const recentPosts = postsExcludingFeatured.slice(0, 2);

// Remaining posts for the list (all others)
const listPosts = postsExcludingFeatured.slice(2);
---

<Layout title="Blog - Jon Labs">
  <AppHeader />

  <main>
    <BlogHero />

    {featuredPost && (
      <FeaturedGrid featured={featuredPost} recentPosts={recentPosts} />
    )}

    {listPosts.length > 0 && (
      <section class="py-8 md:py-12 bg-[var(--main-bg)]">
        <div class="max-w-6xl mx-auto px-4">
          <!-- Section title -->
          <div class="flex items-center gap-3 mb-4">
            <span class="text-xs font-mono uppercase tracking-[0.2em] text-gray-500">
              Tous les articles
            </span>
            <span class="h-px flex-1 bg-gray-200"></span>
          </div>

          <BlogFilters />

          <!-- Simple list with spotlight effect -->
          <div id="posts-list" class="posts-list bg-white border-2 border-black p-4 md:p-6">
            {listPosts.map((post) => (
              <PostListItem post={post} />
            ))}
          </div>

          <!-- Empty state message -->
          <div id="no-results" class="hidden bg-white border-2 border-black p-8 text-center">
            <i class="ri-search-line text-4xl text-gray-300 mb-4"></i>
            <p class="text-gray-500 font-medium">Aucun article ne correspond à votre recherche.</p>
            <button
              id="reset-filters"
              class="mt-4 px-4 py-2 text-sm font-medium bg-[var(--blue)] border-2 border-black shadow-[2px_2px_0px_rgba(0,0,0,1)] hover:shadow-[1px_1px_0px_rgba(0,0,0,1)] hover:translate-x-[1px] hover:translate-y-[1px] transition-all"
            >
              Réinitialiser les filtres
            </button>
          </div>

          <!-- Pagination -->
          <nav id="pagination" class="flex justify-center items-center gap-2 mt-8" aria-label="Pagination">
            <button
              id="prev-page"
              class="w-10 h-10 flex items-center justify-center border-2 border-black bg-white transition-all duration-200 hover:bg-[var(--blue)] disabled:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-gray-100"
              aria-label="Page précédente"
            >
              <i class="ri-arrow-left-line"></i>
            </button>
            <div id="page-numbers" class="flex gap-2">
              <!-- Generated by JS -->
            </div>
            <button
              id="next-page"
              class="w-10 h-10 flex items-center justify-center border-2 border-black bg-white transition-all duration-200 hover:bg-[var(--blue)] disabled:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-gray-100"
              aria-label="Page suivante"
            >
              <i class="ri-arrow-right-line"></i>
            </button>
          </nav>
        </div>
      </section>
    )}
  </main>

  <AppFooter />
</Layout>

<style>
  /* Spotlight effect on hover */
  .posts-list:hover :global(.post-list-item) {
    opacity: 0.4;
  }

  .posts-list :global(.post-list-item:hover) {
    opacity: 1;
  }

  .posts-list :global(.post-list-item) {
    transition: opacity 0.3s ease;
  }
</style>
