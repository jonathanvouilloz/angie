---
import '../styles/global.css'
import Layout from "../layouts/Layout.astro"

import Header from '../components/Header.astro'
import Footer from '../components/Footer.astro'

// CV Components
import CVHero from '../components/cv/CVHero.astro'
import CVProfile from '../components/cv/CVProfile.astro'
import CVFormation from '../components/cv/CVFormation.astro'
import CVTimeline from '../components/cv/CVTimeline.astro'
import CVProjects from '../components/cv/CVProjects.astro'
import CVSkills from '../components/cv/CVSkills.astro'
import CVLanguages from '../components/cv/CVLanguages.astro'
import CVInterests from '../components/cv/CVInterests.astro'
import CVFooter from '../components/cv/CVFooter.astro'
import Modal from '../components/Modal.astro'
---

<Layout
  title="CV - Jonathan Vouilloz | Développeur & Créateur Digital | Jon Labs"
  description="CV de Jonathan Vouilloz, informaticien de gestion et créateur digital. Développement web, automatisation, applications sur-mesure. Basé à Genève."
>
  <Header />

  <main class="cv-page">
    <CVHero />
    <CVProfile />
    <CVFormation />
    <CVTimeline />
    <CVProjects />
    <CVSkills />
    <CVLanguages />
    <CVInterests />
    <CVFooter />
  </main>

  <Footer />

  <!-- Modal CV Download -->
  <Modal
    id="cv-modal"
    title="Fichier en compilation"
    message="Le CV PDF est en cours de préparation. Revenez bientôt !"
    buttonText="Compris"
    icon="ri-loader-4-line"
  />
</Layout>

<script>
  // GSAP ScrollTrigger setup
  import gsap from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';

  gsap.registerPlugin(ScrollTrigger);

  // Hero load animation
  gsap.from('.cv-hero-animate', {
    opacity: 0,
    y: 30,
    duration: 0.8,
    stagger: 0.1,
    ease: 'power3.out',
    delay: 0.2
  });

  // Section reveal animations
  gsap.utils.toArray('.cv-section').forEach((section: any) => {
    gsap.from(section, {
      scrollTrigger: {
        trigger: section,
        start: 'top 85%',
        toggleActions: 'play none none none'
      },
      opacity: 0,
      y: 40,
      duration: 0.8,
      ease: 'power3.out'
    });
  });

  // Timeline progress bar
  const timelineBar = document.querySelector('.timeline-progress-bar');
  if (timelineBar) {
    gsap.to(timelineBar, {
      scrollTrigger: {
        trigger: '.cv-timeline-section',
        start: 'top 60%',
        end: 'bottom 40%',
        scrub: 1
      },
      scaleY: 1,
      transformOrigin: 'top center'
    });
  }

  // Timeline points activation
  gsap.utils.toArray('.timeline-point').forEach((point: any, i: number) => {
    gsap.to(point, {
      scrollTrigger: {
        trigger: point,
        start: 'top 70%',
        toggleActions: 'play none none none'
      },
      scale: 1,
      opacity: 1,
      duration: 0.4,
      ease: 'back.out(1.7)',
      delay: i * 0.1
    });
  });

  // Skills badges cascade
  gsap.utils.toArray('.skill-badge').forEach((badge: any, i: number) => {
    gsap.from(badge, {
      scrollTrigger: {
        trigger: badge.closest('.cv-skills-section'),
        start: 'top 70%',
        toggleActions: 'play none none none'
      },
      opacity: 0,
      scale: 0.8,
      y: 20,
      duration: 0.4,
      ease: 'back.out(1.7)',
      delay: i * 0.03
    });
  });

  // Pixel explosion effect on CVFooter
  function triggerPixelExplosion() {
    const container = document.getElementById('pixel-explosion');
    const card = document.getElementById('contact-card');
    if (!container || !card) return;

    const colors = ['#00D9A3', '#A300D9', '#00A87D', '#000000', '#00D9A3', '#A300D9'];
    const pixelCount = 45; // More pixels
    const cardWidth = card.offsetWidth;
    const cardHeight = card.offsetHeight;

    for (let i = 0; i < pixelCount; i++) {
      const pixel = document.createElement('div');
      pixel.className = 'pixel';

      // Random color
      const color = colors[Math.floor(Math.random() * colors.length)];
      pixel.style.backgroundColor = color;

      // Random size (6-12px)
      const size = 6 + Math.random() * 6;
      pixel.style.width = `${size}px`;
      pixel.style.height = `${size}px`;

      // Position on card edges AND center (for more explosion feel)
      const edge = Math.floor(Math.random() * 5); // 0:top, 1:right, 2:bottom, 3:left, 4:center
      let startX: number, startY: number, endX: number, endY: number;
      const distance = 80 + Math.random() * 150; // Longer travel distance

      switch(edge) {
        case 0: // top
          startX = Math.random() * cardWidth;
          startY = Math.random() * 20;
          endX = startX + (Math.random() - 0.5) * 300;
          endY = -distance;
          break;
        case 1: // right
          startX = cardWidth - Math.random() * 20;
          startY = Math.random() * cardHeight;
          endX = cardWidth + distance;
          endY = startY + (Math.random() - 0.5) * 300;
          break;
        case 2: // bottom
          startX = Math.random() * cardWidth;
          startY = cardHeight - Math.random() * 20;
          endX = startX + (Math.random() - 0.5) * 300;
          endY = cardHeight + distance;
          break;
        case 3: // left
          startX = Math.random() * 20;
          startY = Math.random() * cardHeight;
          endX = -distance;
          endY = startY + (Math.random() - 0.5) * 300;
          break;
        default: // center explosion
          startX = cardWidth / 2 + (Math.random() - 0.5) * 100;
          startY = cardHeight / 2 + (Math.random() - 0.5) * 100;
          const angle = Math.random() * Math.PI * 2;
          endX = startX + Math.cos(angle) * distance * 1.5;
          endY = startY + Math.sin(angle) * distance * 1.5;
      }

      pixel.style.left = `${startX}px`;
      pixel.style.top = `${startY}px`;
      pixel.style.setProperty('--tx', `${endX - startX}px`);
      pixel.style.setProperty('--ty', `${endY - startY}px`);

      // Random delay for stagger effect (shorter for more impact)
      pixel.style.animationDelay = `${Math.random() * 0.15}s`;

      container.appendChild(pixel);
    }

    // Clean up pixels after animation
    setTimeout(() => {
      container.innerHTML = '';
    }, 3500);
  }

  // Card zoom + pixel explosion when footer comes into view
  ScrollTrigger.create({
    trigger: '.cv-footer',
    start: 'top 35%',
    once: true,
    onEnter: () => {
      const card = document.getElementById('contact-card');
      if (card) {
        // Add zoom class for the card animation
        card.classList.add('card-zoom-in');

        // Trigger pixels after zoom completes
        setTimeout(() => {
          triggerPixelExplosion();
        }, 250);
      }
    }
  });

  // Modal CV download
  const modal = document.getElementById('cv-modal');
  const openButtons = document.querySelectorAll('[data-open-cv-modal]');
  const closeElements = document.querySelectorAll('[data-close-modal]');

  openButtons.forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      modal?.classList.remove('hidden');
    });
  });

  closeElements.forEach(el => {
    el.addEventListener('click', () => {
      modal?.classList.add('hidden');
    });
  });

  // Close modal on Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modal && !modal.classList.contains('hidden')) {
      modal.classList.add('hidden');
    }
  });
</script>

<style is:global>
  /* Prevent horizontal scroll issues - using clip instead of hidden */
  html {
    overflow-x: clip;
  }

  body {
    overflow-x: clip;
    max-width: 100vw;
    position: relative;
  }

  .cv-page {
    overflow: clip;
    position: relative;
    width: 100%;
  }

  /* Ensure all sections don't overflow */
  .cv-section {
    overflow: clip;
    max-width: 100vw;
  }

  /* Timeline progress bar initial state */
  .timeline-progress-bar {
    transform: scaleY(0);
  }

  /* Timeline points initial state */
  .timeline-point {
    transform: scale(0);
    opacity: 0;
  }

  /* Card zoom animation */
  #contact-card {
    transform-origin: center center;
  }

  #contact-card.card-zoom-in {
    animation: cardZoomIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
  }

  @keyframes cardZoomIn {
    0% {
      transform: scale(1.08);
    }
    100% {
      transform: scale(1);
    }
  }

  /* Pixel explosion animation */
  .pixel {
    position: absolute;
    animation: pixelExplode 2s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
  }

  @keyframes pixelExplode {
    0% {
      transform: translate(0, 0) scale(1.2);
      opacity: 1;
    }
    20% {
      opacity: 1;
      transform: translate(calc(var(--tx) * 0.3), calc(var(--ty) * 0.3)) scale(1);
    }
    60% {
      opacity: 0.9;
    }
    100% {
      transform: translate(var(--tx), var(--ty)) scale(0.2);
      opacity: 0;
    }
  }

  /* Ensure pixel container can show overflow */
  .pixel-explosion-container {
    overflow: visible !important;
  }

  /* Override section overflow for footer to show pixels */
  .cv-footer {
    overflow: visible !important;
  }
</style>
